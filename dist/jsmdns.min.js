function findServices(e){fundServicesCallback=e,finder&&finder.shutdown(),finder=new ServiceFinder(callback_)}var DataWriter=function(e){var t=0,r=new Uint8Array(new ArrayBuffer(e||512));this.byte_=function(e){r[t]=e,++t,this.buffer=r.buffer.slice(0,t)}.bind(this)};DataWriter.prototype["byte"]=function(e){return this.byte_(e),this},DataWriter.prototype["short"]=function(e){return this["byte"](e>>8&255)["byte"](255&e)},DataWriter.prototype["long"]=function(e){return this["short"](e>>16&65535)["short"](65535&e)},DataWriter.prototype.name=function(e,t){var r=e.split(".");return r.forEach(function(e){this["byte"](e.length);for(var t=0;t<e.length;++t)this["byte"](e.charCodeAt(t))}.bind(this)),t?this["byte"](192)["byte"](t):this["byte"](0),this};var DataConsumer=function(e){this.view_=e instanceof Uint8Array?e:new Uint8Array(e),this.loc_=0};DataConsumer.prototype.isEOF=function(){return this.loc_>=this.view_.byteLength},DataConsumer.prototype.slice=function(e){var t=this.view_.subarray(this.loc_,this.loc_+e);return this.loc_+=e,t},DataConsumer.prototype["byte"]=function(){return this.loc_+=1,this.view_[this.loc_-1]},DataConsumer.prototype["short"]=function(){return(this["byte"]()<<8)+this["byte"]()},DataConsumer.prototype["long"]=function(){return(this["short"]()<<16)+this["short"]()},DataConsumer.prototype.name=function(){for(var e=[];;){var t=this["byte"]();if(!t)break;if(192==t){{this["byte"]()}break}for(var r="";t-->0;)r+=String.fromCharCode(this["byte"]());e.push(r)}return e.join(".")};var DNSPacket=function(e){this.flags_=e||0,this.data_={qd:[],an:[],ns:[],ar:[]}};DNSPacket.parse=function(e){var t=new DataConsumer(e);if(t["short"]())throw new Error("DNS packet must start with 00 00");for(var r=t["short"](),i={qd:t["short"](),an:t["short"](),ns:t["short"](),ar:t["short"]()},n=new DNSPacket(r),o=0;o<i.qd;++o){var s=new DNSRecord(t.name(),t["short"](),t["short"]());n.push("qd",s)}return["an","ns","ar"].forEach(function(e){for(var r=0;r<i[e];++r){var o=new DNSRecord(t.name(),t["short"](),t["short"](),t["long"](),t.slice(t["short"]()));n.push(e,o)}}),t.isEOF()||console.warn("was not EOF on incoming packet"),n},DNSPacket.prototype.push=function(e,t){this.data_[e].push(t)},DNSPacket.prototype.each=function(e){var t,r=!1;2==arguments.length?t=arguments[1]:(r=arguments[1],t=arguments[2]),this.data_[e].forEach(function(e){r&&e.type!=r||t(e)})},DNSPacket.prototype.serialize=function(){var e=new DataWriter,t=["qd","an","ns","ar"];return e["short"](0)["short"](this.flags_),t.forEach(function(t){e["short"](this.data_[t].length)}.bind(this)),t.forEach(function(t){this.data_[t].forEach(function(r){if(e.name(r.name)["short"](r.type)["short"](r.cl),"qd"!=t)throw new Error("can't yet serialize non-QD records")})}.bind(this)),e.buffer};var DNSRecord=function(e,t,r,i,n){this.name=e,this.type=t,this.cl=r,this.isQD=3==arguments.length,this.isQD||(this.ttl=i,this.data_=n)};DNSRecord.prototype.asName=function(){return new DataConsumer(this.data_).name()};var ServiceFinder=function(e){this.callback_=e,this.byIP_={},this.byService_={},this.onReceiveListener_=this.onReceive_.bind(this),chrome.sockets.udp.onReceive.addListener(this.onReceiveListener_),this.onReceiveErrorListener_=this.onReceiveError_.bind(this),chrome.sockets.udp.onReceiveError.addListener(this.onReceiveErrorListener_),ServiceFinder.forEachAddress_(function(e,t){return t?(this.callback_(t),!0):-1!=e.indexOf(":")?(console.log("IPv6 address unsupported",e),!0):(console.log("Broadcasting to address",e),void ServiceFinder.bindToAddress_(e,function(t){return t?void this.broadcast_(t,e):(this.callback_("could not bind UDP socket"),!0)}.bind(this)))}.bind(this)),setTimeout(function(){Object.keys(this.byIP_).length||this.callback_("no mDNS services found!")}.bind(this),1e4)};ServiceFinder.forEachAddress_=function(e){chrome.system.network.getNetworkInterfaces(function(t){return t.length?void t.forEach(function(t){e(t.address,null)}):(e(null,"no network available!"),!0)})},ServiceFinder.bindToAddress_=function(e,t){chrome.sockets.udp.create({},function(r){chrome.sockets.udp.bind(r.socketId,e,0,function(e){t(e>=0?r.socketId:null)})})},ServiceFinder.sortIps_=function(e){return e.sort(ServiceFinder.sortIps_.sort),e},ServiceFinder.sortIps_.sort=function(e,t){for(var r=e.split(".").map(ServiceFinder.sortIps_.toInt_),i=t.split(".").map(ServiceFinder.sortIps_.toInt_),n=0;n<Math.min(r.length,i.length);++n){if(r[n]<i[n])return-1;if(r[n]>i[n])return 1}return 0},ServiceFinder.sortIps_.toInt_=function(e){return+e},ServiceFinder.prototype.services=function(e){var t=Object.keys(e?this.byIP_[e]:this.byService_);return t.sort(),t},ServiceFinder.prototype.ips=function(e){var t=Object.keys(e?this.byService_[e]:this.byIP_);return ServiceFinder.sortIps_(t)},ServiceFinder.prototype.onReceive_=function(e){var t=function(e,t,r){return t in e||0==(e[t]=r),e[t]},r=DNSPacket.parse(e.data),i=t(this.byIP_,e.remoteAddress,{});r.each("an",12,function(r){var n=r.asName(),o=t(this.byService_,n,{});o[e.remoteAddress]=!0,i[n]=!0}.bind(this)),this.callback_pending_||(this.callback_pending_=!0,setTimeout(function(){this.callback_pending_=void 0,this.callback_()}.bind(this),25))},ServiceFinder.prototype.onReceiveError_=function(e){return this.callback_(e.resultCode),!0},ServiceFinder.prototype.broadcast_=function(e,t){var r=new DNSPacket;r.push("qd",new DNSRecord("_services._dns-sd._udp.local",12,1));var i=r.serialize();chrome.sockets.udp.send(e,i,"224.0.0.251",5353,function(e){e.resultCode<0&&this.callback_("Could not send data to:"+t)})},ServiceFinder.prototype.shutdown=function(){chrome.sockets.udp.onReceive.removeListener(this.onReceiveListener_),chrome.sockets.udp.onReceiveError.removeListener(this.onReceiveErrorListener_),chrome.sockets.udp.getSockets(function(e){e.forEach(function(e){chrome.sockets.udp.close(e.socketId)})})};var finder,mode="service",fundServicesCallback,callback_=function(e){var t=[];if(e)return console.warn(e);var r=finder.services,i=finder.ips;r.apply(finder).forEach(function(e){var r={};r.service=e;var n=[];i.call(finder,e).forEach(function(e){n.push(e)}),r.ips=n,t.push(r)}),"function"==typeof fundServicesCallback&&fundServicesCallback(t)},serviceTypes={"_acrobatSRV._tcp":"Adobe Acrobat","_adisk._tcp":"Apple TimeMachine","_adobe-vc._tcp":"Adobe Version Cue","_afpovertcp._tcp":"Apple File Sharing","_airport._tcp":"Apple AirPort","_apt._tcp":"APT Package Repository","_bzr._tcp":"Bazaar","_cros_p2p._tcp":"Chrome OS P2P Update","_daap._tcp":"iTunes Audio Access","_dacp._tcp":"iTunes Remote Control","_distcc._tcp":"Distributed Compiler","_domain._udp":"DNS Server","_dpap._tcp":"Digital Photo Sharing","_ftp._tcp":"FTP File Transfer","_h323._tcp":"H.323 Telephony","_home-sharing._tcp":"Apple Home Sharing","_https._tcp":"Secure Web Site","_http._tcp":"Web Site","_iax._udp":"Asterisk Exchange","_imap._tcp":"IMAP Mail Access","_ipp._tcp":"Internet Printer","_ksysguard._tcp":"KDE System Guard","_ldap._tcp":"LDAP Directory Server","_libvirt._tcp":"Virtual Machine Manager","_lobby._tcp":"Gobby Collaborative Editor Session","_MacOSXDupSuppress._tcp":"MacOS X Duplicate Machine Suppression","_mpd._tcp":"Music Player Daemon","_mumble._tcp":"Mumble Server","_net-assistant._udp":"Apple Net Assistant","_nfs._tcp":"Network File System","_ntp._udp":"NTP Time Server","_odisk._tcp":"DVD or CD Sharing","_omni-bookmark._tcp":"OmniWeb Bookmark Sharing","_pdl-datastream._tcp":"PDL Printer","_pgpkey-hkp._tcp":"GnuPG/PGP HKP Key Server","_pop3._tcp":"POP3 Mail Access","_pop3._tcp":"Posta - POP3","_postgresql._tcp":"PostgreSQL Server","_presence_olpc._tcp":"OLPC Presence","_presence._tcp":"iChat Presence","_printer._tcp":"UNIX Printer","_pulse-server._tcp":"PulseAudio Sound Server","_pulse-sink._tcp":"PulseAudio Sound Sink","_pulse-source._tcp":"PulseAudio Sound Source","_raop._tcp":"AirTunes Remote Audio","_realplayfavs._tcp":"RealPlayer Shared Favorites","_remote-jukebox._tcp":"Remote Jukebox","_rfb._tcp":"VNC Remote Access","_rss._tcp":"Web Syndication RSS","_rtp._udp":"RTP Realtime Streaming Server","_rtsp._tcp":"RTSP Realtime Streaming Server","_see._tcp":"SubEthaEdit Collaborative Text Editor","_sftp-ssh._tcp":"SFTP File Transfer","_shifter._tcp":"Window Shifter","_sip._udp":"SIP Telephony","_skype._tcp":"Skype VoIP","_smb._tcp":"Microsoft Windows Network","_ssh._tcp":"SSH Remote Terminal","_svn._tcp":"Subversion Revision Control","_telnet._tcp":"Telnet Remote Terminal","_tftp._udp":"TFTP Trivial File Transfer","_timbuktu._tcp":"Timbuktu Remote Desktop Control","_touch-able._tcp":"iPod Touch Music Library","_tp-https._tcp":"Thousand Parsec Server (Secure HTTP Tunnel)","_tp-http._tcp":"Thousand Parsec Server (HTTP Tunnel)","_tps._tcp":"Thousand Parsec Server (Secure)","_tp._tcp":"Thousand Parsec Server","_udisks-ssh._tcp":"Remote Disk Management","_vlc-http._tcp":"VLC Streaming","_webdavs._tcp":"Secure WebDAV File Share","_webdav._tcp":"WebDAV File Share","_workstation._tcp":"Workstation"};